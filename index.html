<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Weather Pro</title>
    <link rel="icon" href="https://fav.farm/⛅">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Weather Pro">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: {
                        'float': 'float 8s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'slide-up': 'slideUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'pulse-glow': 'pulseGlow 3s ease-in-out infinite',
                        'pulse-heart': 'pulseHeart 1.5s ease-in-out infinite',
                        'spin-slow': 'spin 20s linear infinite',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(40px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pulseGlow: { '0%, 100%': { opacity: '0.6' }, '50%': { opacity: '1' } },
                        pulseHeart: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.15)' } }
                    }
                }
            }
        }
    </script>

    <!-- Libraries -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior-y: none; touch-action: manipulation; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Improved Visibility: Darker, more opaque glass for better contrast */
        .glass-panel {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .glass-highlight {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.2s ease;
        }
        /* Text Shadow for legibility */
        .text-shadow {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="antialiased bg-slate-950 text-white selection:bg-indigo-500/30">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, size = 24, className = "", fill = "none", color }) => {
            useEffect(() => lucide.createIcons(), [name]);
            return <i data-lucide={name} className={className} fill={fill} style={{ width: size, height: size, color: color }}></i>;
        };

        // --- Configs ---
        const getAQIStatus = (aqi) => {
            if (aqi <= 50) return { label: "Excellent", color: "text-emerald-400", bar: "bg-emerald-500", heartAdvice: "Perfect air quality for outdoor cardio.", icon: "heart" };
            if (aqi <= 100) return { label: "Moderate", color: "text-yellow-400", bar: "bg-yellow-500", heartAdvice: "Acceptable. Monitor if you are sensitive.", icon: "activity" };
            if (aqi <= 150) return { label: "Sensitive", color: "text-orange-400", bar: "bg-orange-500", heartAdvice: "Reduce prolonged outdoor exertion.", icon: "alert-circle" };
            return { label: "Unhealthy", color: "text-red-500", bar: "bg-red-600", heartAdvice: "Avoid outdoor activities to protect heart.", icon: "alert-triangle" };
        };

        const getAdvice = (code, temp) => {
            if ([95, 96, 99].includes(code)) return { text: "Stormy! Stay safe indoors.", icon: "zap" };
            if ([51, 61, 80].includes(code)) return { text: "Don't forget your umbrella.", icon: "umbrella" };
            if ([71, 73, 75].includes(code)) return { text: "Bundle up! It's freezing.", icon: "snowflake" };
            if (temp > 30) return { text: "Heat warning. Stay cool.", icon: "droplets" };
            if (temp > 20 && code === 0) return { text: "Great day for a walk!", icon: "footprints" };
            if (temp < 10) return { text: "Time for a heavy coat.", icon: "shirt" };
            return { text: "Enjoy the weather!", icon: "smile" };
        };

        const getWeatherConfig = (code, isDay) => {
            const time = isDay ? 'day' : 'night';
            const c = {
                clear: { day: { gradient: "bg-gradient-to-b from-sky-500 to-blue-700", icon: "sun", label: "Sunny", accent: "shadow-yellow-400", iconColor: "#FDB813" }, 
                         night: { gradient: "bg-gradient-to-b from-slate-900 to-indigo-950", icon: "moon", label: "Clear", accent: "shadow-indigo-400", iconColor: "#E0E7FF" } },
                cloudy: { day: { gradient: "bg-gradient-to-b from-slate-500 to-slate-700", icon: "cloud", label: "Cloudy", accent: "shadow-white", iconColor: "#fff" },
                          night: { gradient: "bg-gradient-to-b from-gray-900 to-slate-800", icon: "cloud", label: "Cloudy", accent: "shadow-gray-500", iconColor: "#94A3B8" } },
                rain: { day: { gradient: "bg-gradient-to-b from-blue-700 to-indigo-900", icon: "cloud-rain", label: "Rainy", accent: "shadow-blue-400", iconColor: "#60A5FA" },
                        night: { gradient: "bg-gradient-to-b from-slate-950 to-black", icon: "cloud-rain", label: "Rainy", accent: "shadow-blue-600", iconColor: "#3B82F6" } }
            };
            if(code === 0) return c.clear[time];
            if([1,2,3].includes(code)) return c.cloudy[time];
            return c.rain[time];
        };

        const formatDayName = (dateString) => new Date(dateString).toLocaleDateString('en-US', { weekday: 'short' });

        // --- Components ---

        const SolarCycle = ({ sunrise, sunset }) => {
            if (!sunrise || !sunset) return null;
            const now = new Date();
            const start = new Date(sunrise).getTime();
            const end = new Date(sunset).getTime();
            const current = now.getTime();
            let progress = ((current - start) / (end - start)) * 100;
            progress = Math.max(0, Math.min(100, progress));
            
            return (
                <div className="glass-panel p-5 rounded-3xl mb-4 relative overflow-hidden">
                    <div className="flex justify-between text-xs opacity-80 font-mono mb-8 font-semibold">
                        <span>{new Date(sunrise).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        <span>{new Date(sunset).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div className="relative h-12 w-full">
                        <svg className="w-full h-full overflow-visible" viewBox="0 0 200 50" preserveAspectRatio="none">
                            <path d="M0,50 Q100,-40 200,50" fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="2" strokeDasharray="4 4" />
                        </svg>
                        <div className="absolute top-0 left-0 w-8 h-8 bg-yellow-300 rounded-full shadow-[0_0_20px_rgba(253,224,71,0.8)] flex items-center justify-center text-yellow-900 transition-all duration-1000 ease-out"
                            style={{ offsetPath: 'path("M0,50 Q100,-40 200,50")', offsetDistance: `${progress}%`, opacity: progress > 0 && progress < 100 ? 1 : 0.3 }}>
                            <Icon name="sun" size={16} fill="currentColor" />
                        </div>
                    </div>
                    <div className="text-center text-xs font-bold tracking-widest uppercase opacity-70 mt-2">Solar Position</div>
                </div>
            );
        };

        const MainWeather = ({ weather, locationName, config, isSaved, onToggleSave }) => {
            const advice = getAdvice(weather.current.weather_code, weather.current.temperature_2m);
            return (
                <div className="relative mb-6">
                    <div className="flex flex-col items-center mb-6 animate-fade-in">
                        <div className="flex items-center gap-2 text-shadow">
                            <Icon name="map-pin" size={14} className="text-indigo-300 drop-shadow-md" />
                            <span className="text-lg font-bold tracking-tight drop-shadow-md">{locationName}</span>
                            <button onClick={onToggleSave} className={`p-1 rounded-full hover:bg-white/10 transition-all ${isSaved ? 'text-yellow-400' : 'opacity-50 hover:opacity-100'}`}>
                                <Icon name="star" size={14} fill={isSaved ? "currentColor" : "none"} />
                            </button>
                        </div>
                        <div className="text-xs font-bold opacity-80 uppercase tracking-widest mt-1 text-shadow">{new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</div>
                    </div>
                    <div className="flex items-center justify-between relative z-10 px-2">
                        <div className="flex flex-col">
                            <h1 className="text-[6rem] font-bold leading-none tracking-tighter drop-shadow-xl text-white">
                                {Math.round(weather.current.temperature_2m)}°
                            </h1>
                            <div className="glass-panel px-3 py-1.5 rounded-full inline-flex items-center gap-2 mt-2 w-fit backdrop-blur-md border-white/20 shadow-lg">
                                <span className="w-2 h-2 rounded-full bg-green-400 animate-pulse shadow-[0_0_8px_rgba(74,222,128,0.8)]"></span>
                                <span className="text-xs font-bold capitalize text-shadow">{config.label}</span>
                            </div>
                        </div>
                        <div className="relative w-32 h-32">
                            <div className={`absolute inset-0 rounded-full opacity-40 blur-2xl ${config.accent.replace('shadow-', 'bg-')}`}></div>
                            <div className="relative w-full h-full animate-float filter drop-shadow-2xl"><Icon name={config.icon} size={110} color={config.iconColor} fill={config.iconColor + "30"} /></div>
                        </div>
                    </div>
                    <div className="mt-6 glass-highlight px-4 py-3 rounded-xl flex items-center gap-3 animate-slide-up mx-1 shadow-lg">
                        <div className="p-1.5 bg-indigo-500/30 rounded-lg text-indigo-200 shrink-0 shadow-inner"><Icon name={advice.icon} size={18} /></div>
                        <div className="flex flex-col">
                            <div className="text-[9px] font-bold uppercase tracking-widest opacity-70">Smart Insight</div>
                            <div className="text-xs font-bold leading-tight text-shadow">{advice.text}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const ForecastStrip = ({ hourly }) => {
            const now = new Date().getHours();
            const nextHours = hourly.time.map((t, i) => ({ time: t, temp: hourly.temperature_2m[i] })).filter(h => new Date(h.time).getHours() > now).slice(0, 5);
            return (
                <div className="glass-panel p-5 rounded-3xl mb-4">
                    <div className="flex justify-between items-end h-24 relative">
                        <div className="absolute bottom-0 left-0 right-0 h-1/2 bg-gradient-to-t from-indigo-500/20 to-transparent rounded-b-2xl pointer-events-none"></div>
                        {nextHours.map((h, i) => (
                            <div key={i} className="flex flex-col items-center justify-end z-10 gap-2">
                                <span className="text-lg font-bold text-shadow">{Math.round(h.temp)}°</span>
                                <div className="h-8 w-1 bg-white/20 rounded-full relative overflow-hidden border border-white/10"><div className="absolute bottom-0 left-0 right-0 bg-indigo-400 rounded-full shadow-[0_0_10px_rgba(129,140,248,0.5)]" style={{ height: `${(h.temp / 40) * 100}%` }}></div></div>
                                <span className="text-xs opacity-70 font-mono font-semibold">{new Date(h.time).getHours()}:00</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- AQI Heart Health Card ---
        const AQIHeartCard = ({ aqi }) => {
            if (!aqi) return null;
            const status = getAQIStatus(aqi);
            return (
                <div className="glass-panel p-5 rounded-3xl mb-4 relative overflow-hidden">
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2">
                            <div className="p-1.5 rounded-lg bg-white/10 border border-white/10"><Icon name="wind" size={16} /></div>
                            <span className="text-sm font-bold uppercase tracking-wide opacity-80 text-shadow">Air Quality</span>
                        </div>
                        <span className={`text-xs font-bold px-2.5 py-1 rounded-full bg-black/30 ${status.color} border border-white/10 shadow-sm`}>{status.label}</span>
                    </div>
                    <div className="flex items-end gap-2 mb-4">
                        <span className="text-4xl font-bold tracking-tighter text-shadow">{aqi}</span>
                        <span className="text-xs opacity-70 mb-1.5 font-medium">US AQI</span>
                    </div>
                    <div className="h-1.5 w-full bg-black/30 rounded-full overflow-hidden mb-5 border border-white/5">
                        <div className={`h-full ${status.bar} transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(255,255,255,0.3)]`} style={{ width: `${Math.min((aqi / 300) * 100, 100)}%` }}></div>
                    </div>
                    <div className="flex items-start gap-3 p-3 bg-black/20 rounded-2xl border border-white/10 backdrop-blur-sm">
                        <div className={`p-2 rounded-full bg-white/5 ${status.color} animate-pulse-heart shrink-0 border border-white/5`}>
                            <Icon name="heart" size={18} fill="currentColor" />
                        </div>
                        <div>
                            <h4 className="text-[10px] font-bold uppercase tracking-wide opacity-70 mb-0.5">Heart Impact</h4>
                            <p className="text-xs font-semibold leading-snug opacity-90 text-shadow">{status.heartAdvice}</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 7-Day Forecast List ---
        const DailyForecast = ({ daily }) => {
            return (
                <div className="glass-panel p-5 rounded-3xl mb-4">
                    <h3 className="text-xs font-bold uppercase tracking-widest opacity-60 mb-4 flex items-center gap-2 text-shadow">
                        <Icon name="calendar-days" size={14} /> 7-Day Forecast
                    </h3>
                    <div className="space-y-3">
                        {daily.time.slice(1, 7).map((t, i) => {
                            const config = getWeatherConfig(daily.weather_code[i+1], true);
                            return (
                                <div key={t} className="flex items-center justify-between p-2.5 hover:bg-white/10 rounded-xl transition-colors border border-transparent hover:border-white/10">
                                    <span className="w-12 font-bold text-sm text-shadow">{formatDayName(t)}</span>
                                    <div className="flex items-center gap-2 opacity-90">
                                        <Icon name={config.icon} size={18} color={config.iconColor} className="drop-shadow-sm" />
                                        <span className="text-xs opacity-70 capitalize font-medium">{config.label}</span>
                                    </div>
                                    <div className="flex gap-3 text-sm font-mono">
                                        <span className="font-bold text-white">{Math.round(daily.temperature_2m_max[i+1])}°</span>
                                        <span className="opacity-60 font-semibold">{Math.round(daily.temperature_2m_min[i+1])}°</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const SearchBar = ({ onSearch, onLocate }) => {
            const [query, setQuery] = useState('');
            const [suggestions, setSuggestions] = useState([]);
            useEffect(() => {
                const timer = setTimeout(async () => {
                    if (query.length > 2) {
                        try {
                            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=3&language=en&format=json`);
                            const data = await res.json();
                            if (data.results) setSuggestions(data.results);
                        } catch (e) {}
                    } else { setSuggestions([]); }
                }, 300);
                return () => clearTimeout(timer);
            }, [query]);
            return (
                <div className="relative w-full mb-4 z-50 flex gap-2 items-center">
                    <div className="relative flex-1 group">
                        <div className="absolute left-3 top-2.5 text-white/60 group-focus-within:text-white transition-colors"><Icon name="search" size={14} /></div>
                        <form onSubmit={(e) => { e.preventDefault(); if(suggestions[0]) onSearch(suggestions[0]); }}>
                            <input type="text" value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Find a city..." className="w-full pl-9 pr-3 py-2 rounded-full glass-input text-white placeholder-white/60 focus:bg-black/50 outline-none ring-0 font-bold text-sm transition-all shadow-inner" />
                        </form>
                    </div>
                    <button onClick={() => onSearch('CURRENT')} className="p-2 rounded-full glass-input hover:bg-white/10 active:scale-95 transition-all text-white/90 border border-white/20 shadow-lg" title="Use Current Location"><Icon name="crosshair" size={16} /></button>
                    {suggestions.length > 0 && (
                        <div className="absolute top-full mt-2 w-full glass-panel bg-black/95 rounded-xl overflow-hidden shadow-2xl backdrop-blur-xl animate-slide-up left-0 z-50 border border-white/20">
                            {suggestions.map(city => (
                                <button key={city.id} onClick={() => { onSearch(city); setSuggestions([]); setQuery(''); }} className="w-full px-4 py-3 text-left hover:bg-white/10 transition-colors border-b border-white/10 last:border-0 flex justify-between text-white">
                                    <span className="font-bold text-sm">{city.name}, <span className="opacity-60 text-xs ml-1 font-normal">{city.country_code}</span></span>
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [saved, setSaved] = useState(localStorage.getItem('favCity'));

            // Fixed: Robust fetch function with error isolation
            const fetchWeather = async (lat, lon, name) => {
                setLoading(true);
                try {
                    // Use safe independent fetches
                    const safeFetch = async (url) => {
                        try {
                            const res = await fetch(url);
                            if (!res.ok) throw new Error(res.statusText);
                            return await res.json();
                        } catch (e) {
                            console.warn("Failed to fetch:", url, e);
                            return null;
                        }
                    };

                    const [w, a] = await Promise.all([
                        safeFetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`),
                        safeFetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi`)
                    ]);

                    if (w) {
                        // Handle case where AQI API fails but weather succeeds
                        const safeAqi = a || { current: { us_aqi: null } };
                        setData({ weather: w, aqi: safeAqi, name });
                    } else {
                        console.error("Main weather data failed to load");
                    }
                } catch(e) { 
                    console.error("Critical fetch error:", e); 
                } finally { 
                    setTimeout(() => setLoading(false), 800); 
                }
            };

            const handleSearch = (loc) => {
                if (loc === 'CURRENT') {
                    navigator.geolocation.getCurrentPosition(
                        p => fetchWeather(p.coords.latitude, p.coords.longitude, "Current Location"),
                        () => fetchWeather(40.71, -74.00, "New York")
                    );
                } else {
                    fetchWeather(loc.latitude, loc.longitude, loc.name);
                }
            };

            useEffect(() => {
                if(saved) {
                    const loc = JSON.parse(saved);
                    fetchWeather(loc.lat, loc.lon, loc.name);
                } else { handleSearch('CURRENT'); }
                
                if('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.protocol === 'http:')) {
                    navigator.serviceWorker.register('sw.js').catch(console.error);
                }
            }, []);

            const toggleSave = () => {
                if(saved && JSON.parse(saved).name === data.name) {
                    localStorage.removeItem('favCity');
                    setSaved(null);
                } else {
                    const loc = { lat: data.weather.latitude, lon: data.weather.longitude, name: data.name };
                    localStorage.setItem('favCity', JSON.stringify(loc));
                    setSaved(JSON.stringify(loc));
                }
            };

            const config = data ? getWeatherConfig(data.weather.current.weather_code, data.weather.current.is_day) : { gradient: 'bg-slate-900', accent: 'shadow-none' };

            return (
                <div className={`min-h-screen ${config.gradient} transition-colors duration-1000 p-4 pb-12 relative overflow-hidden flex flex-col`}>
                    <div className="absolute top-[-20%] left-[-20%] w-[140%] h-[80%] bg-gradient-to-b from-white/5 to-transparent rounded-full blur-[100px] pointer-events-none"></div>
                    <div className="max-w-md mx-auto w-full z-20 pt-2"><SearchBar onSearch={handleSearch} /></div>
                    <div className="flex-1 relative z-10 flex flex-col max-w-md mx-auto w-full">
                        {loading ? (
                            <div className="space-y-4 animate-pulse mt-4">
                                <div className="h-8 w-1/2 bg-white/10 rounded-full mx-auto mb-8"></div>
                                <div className="h-40 w-full bg-white/10 rounded-3xl mb-4"></div>
                                <div className="h-24 w-full bg-white/5 rounded-3xl"></div>
                            </div>
                        ) : data && (
                            <>
                                <MainWeather weather={data.weather} locationName={data.name} config={config} isSaved={saved && JSON.parse(saved).name === data.name} onToggleSave={toggleSave} />
                                <ForecastStrip hourly={data.weather.hourly} />
                                <SolarCycle sunrise={data.weather.daily.sunrise[0]} sunset={data.weather.daily.sunset[0]} />
                                <AQIHeartCard aqi={data.aqi.current.us_aqi} />
                                <DailyForecast daily={data.weather.daily} />
                            </>
                        )}
                    </div>
                    <footer className="mt-8 text-center"><a href="https://github.com/Hayagriva0" target="_blank" className="inline-flex items-center gap-2 text-[10px] font-bold tracking-[0.2em] uppercase opacity-60 hover:opacity-100 transition-opacity text-shadow"><Icon name="github" size={12} /> Designed by Abhra</a></footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
